# config.py
#  TuxOstat configuration program
# TuxOstat - Linux-based thermostat <http://www.jasonantman.com>
# Copyright 2008 Jason Antman. <jason@jasonantman.com>.
# Licensed under Version 3 or later of the GNU GPL.
#  Time-stamp: "2008-06-10 01:45:50 tuxostat"
#  $Id: tuxOstat_config.py,v 1.1.1.1 2008/06/10 14:14:59 jantman Exp $

import cPickle as pickle
import shutil
import time
import os.path

class tuxOstat_config:
    """
    This class handles all reading and writing of the configuration files and schedule.
    """

    SCHEDULE_FILE = '/etc/tuxostat/schedule.pkl'
    SCHEDULE = None

    # non-private variables
    days = {0: "M ", 1: "Tu", 2: "W ", 3: "Th", 4: "F ", 5: "Sa", 6: "Su"} # day names - string length 2
    HVACmodes = {0: "DEF ", 1: "COOL", 2: "HEAT", 3: "EITH", 4: "OFF "} # HVAC system mode - string length 4
    zoneModes = {0: "Mean", 1: "MED ", 2: "Wmed", 3: "OUTL", 4: "ZONE"} # how to use zones - string length 4
    tempModes = {0: "Time", 1: "Temp"} # how to handle temperature - string length 4

    def __init__(self):
        """
        Instantiate the config object, and load in the config and schedule.
        """
	self.LoadSchedule()

    def LoadSchedule(self):
	"""
	Read-in (unpickle) the schedule.
	"""
	if os.path.exists(self.SCHEDULE_FILE):
	        f2 = file(self.SCHEDULE_FILE, 'rb')
		self.SCHEDULE = pickle.load(f2)
		f2.close()
	else:
		self.SCHEDULE = {}

    def GetSchedule(self):
        """
        This returns the entire schedule, which is a list of dictionaries.
        """
        return self.SCHEDULE

    def AddTaskBefore(self, task, beforeIndex):
        """
        This adds a new task into the schedule before the specified index. The task should be a dictionary. This function does NOT write out the schedule (pickle it), it just adds to the current data structure, so the user has a chance to review and confirm changes.
        """
        self.SCHEDULE.add(beforeIndex, task)

    def WriteSchedule(self):
        """
        Write out (pickle) the schedule. First, it moves the old file to /etc/tuxostat/schedule_{current_integer_timestamp}.pkl. Returns the filename that the old schedule was moved to.
        """
	newname = '/etc/tuxostat/schedule_'+str(int(time.time()))+'.pkl'
	shutil.move('/etc/tuxostat/schedule.pkl', newname)
        f2 = file(self.SCHEDULE_FILE, 'wb')
        pickle.dump(self.SCHEDULE, f2, False)
        f2.close()
	return newname

    def GetSheduleNumTasks(self):
	"""
	Returns the integer number of tasks in the current schedule.
	"""
	return len(self.SCHEDULE)

    def RemoveScheduleTask(self, index):
	"""
	Removes the schedule task at the specified index.
	"""
	self.SCHEDULE.pop(index)
	return True

    def ReplaceTask(self, index, task):
	"""
	Replaces the current task at index with a new task dictionary "task"
	"""
	if index < 0 or index > len(self.SCHEDULE):
	   return False
	self.SCHEDULE[index] = task
	return True
